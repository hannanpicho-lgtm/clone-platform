name: Deploy to Production

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

jobs:
  test:
    name: Test & Validate
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint
        run: npm run lint --if-present
        continue-on-error: true
      
      - name: Run tests
        run: npm run test:smoke
        env:
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          FUNCTION_URL: ${{ secrets.FUNCTION_URL }}
  
  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build frontend
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist
          path: dist/
          retention-days: 5
  
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Setup Supabase CLI
        run: |
          npm install -g supabase
          supabase --version
      
      - name: Deploy Edge Function
        run: npx supabase functions deploy make-server-44a642d3 --no-verify-jwt
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
      
      - name: Health Check
        run: |
          FUNCTION_URL="${{ secrets.FUNCTION_URL }}"
          echo "Checking health at: $FUNCTION_URL"
          
          for i in {1..5}; do
            if curl -f "$FUNCTION_URL/health" > /dev/null 2>&1; then
              echo "✅ Health check passed"
              exit 0
            fi
            echo "Attempt $i/5: Health check failed, retrying in 10 seconds..."
            sleep 10
          done
          
          echo "❌ Health check failed after 5 attempts"
          exit 1
      
      - name: Post-Deployment Tests
        run: npm run test:smoke
        env:
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          FUNCTION_URL: ${{ secrets.FUNCTION_URL }}
      
      - name: Create Deployment
        uses: actions/github-script@v6
        if: success()
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: 'production',
              description: 'Clone Platform',
              auto_merge: false,
              required_contexts: []
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              description: 'Deployment succeeded',
              environment_url: '${{ secrets.FUNCTION_URL }}'
            });
      
      - name: Notify Slack (Success)
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: '✅ Production deployment successful'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
      
      - name: Notify Slack (Failure)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: '❌ Production deployment failed'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
  
  rollback:
    name: Rollback (if Deploy Fails)
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Check out previous version
        run: |
          git checkout HEAD~1 -- supabase/functions/server/index.tsx
          echo "Rolled back to previous version"
      
      - name: Rebuild and redeploy
        run: |
          npm install
          npm run build
          npx supabase functions deploy make-server-44a642d3 --no-verify-jwt
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
      
      - name: Notify Slack (Rollback)
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '⚠️ Production deployment failed - rolled back to previous version',
              color: 'warning',
              fields: [{
                title: 'Repo',
                value: context.payload.repository.full_name,
                short: true
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
